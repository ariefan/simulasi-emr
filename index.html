<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>RME Koas Simulator - Scaffolding Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    .app-shell {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      min-height: 100vh;
    }
    .sidebar {
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      border-right: 1px solid rgba(148, 163, 184, 0.4);
    }
    .sidebar-header {
      padding: 0.75rem 0.75rem 0.5rem;
      border-radius: 0.75rem;
      background: radial-gradient(circle at top left, #22c55e, #22c55e22 45%, transparent 70%);
      position: relative;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .sidebar-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, #0f172a88, #020617);
      mix-blend-mode: multiply;
    }
    .sidebar-header-content {
      position: relative;
      z-index: 1;
    }
    .sidebar-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #bbf7d0;
      margin-bottom: 0.25rem;
    }
    .sidebar-main-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.25rem;
    }
    .sidebar-subtitle {
      font-size: 0.8rem;
      color: #e5e7eb;
      opacity: 0.9;
    }
    .student-card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .student-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
    }
    .student-input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }
    .student-input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e;
    }
    .student-note {
      margin-top: 0.35rem;
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .sidebar-section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #9ca3af;
      margin: 0.5rem 0 0.25rem;
    }
    .case-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.25rem;
      margin-top: 0.25rem;
    }
    .case-card {
      border-radius: 0.6rem;
      padding: 0.5rem 0.55rem;
      margin-bottom: 0.35rem;
      background: #020617;
      border: 1px solid #1f2937;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .case-card:hover {
      border-color: #22c55e;
      transform: translateY(-1px);
      background: #020617;
    }
    .case-card.active {
      border-color: #22c55e;
      background: #022c22;
    }
    .case-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 0.15rem;
    }
    .case-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: center;
    }
    .case-meta-pill {
      padding: 0.05rem 0.35rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .case-meta-tag {
      padding: 0.05rem 0.35rem;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.9);
      color: #9ca3af;
    }
    .case-difficulty {
      margin-left: auto;
      font-size: 0.7rem;
    }
    .difficulty-pill {
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }
    .difficulty-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #facc15;
    }
    .difficulty-label {
      text-transform: lowercase;
    }
    .main {
      display: flex;
      flex-direction: column;
      padding: 0.75rem 1rem 1rem;
      gap: 0.75rem;
    }
    .main-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .main-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .case-breadcrumb {
      font-size: 0.7rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 0.15rem;
    }
    .case-main-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.1rem;
    }
    .case-subtitle {
      font-size: 0.8rem;
      color: #4b5563;
    }
    .header-right {
      min-width: 260px;
      background: #ffffff;
      border-radius: 0.9rem;
      padding: 0.6rem 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .header-right-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
      margin-bottom: 0.15rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }
    .stat-label {
      color: #6b7280;
    }
    .stat-value {
      font-weight: 600;
      color: #111827;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 0.15rem;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #22c55e, #16a34a);
      transition: width 0.2s ease;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: #4b5563;
    }
    .tab-header-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.4rem 0.6rem;
      background: #f9fafb;
      border-radius: 0.8rem;
      border: 1px solid #e5e7eb;
    }
    .tab-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      cursor: pointer;
      background: #f3f4f6;
      color: #4b5563;
      opacity: 0.6;
    }
    .tab-pill.enabled {
      opacity: 1;
    }
    .tab-pill.active {
      border-color: #22c55e;
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
    }
    .tab-pill .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid #6b7280;
      background: #f9fafb;
    }
    .tab-pill.completed .status-dot {
      background: #22c55e;
      border-color: #16a34a;
    }
    .content {
      margin-top: 0.4rem;
      background: #ffffff;
      border-radius: 1rem;
      padding: 0.75rem 0.9rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.06);
      min-height: 380px;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 0.1rem;
    }
    .section-subtitle {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 0.4rem;
    }
    .case-text {
      font-size: 0.88rem;
      line-height: 1.55;
      color: #111827;
      white-space: pre-line;
      background: #f9fafb;
      border-radius: 0.75rem;
      padding: 0.6rem 0.7rem;
      border: 1px dashed #e5e7eb;
    }
    .gate-questions {
      margin-top: 0.7rem;
      padding-top: 0.6rem;
      border-top: 1px dashed #e5e7eb;
    }
    .gate-question {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .gate-question label {
      font-size: 0.8rem;
      color: #374151;
      font-weight: 500;
    }
    .gate-question textarea {
      min-height: 64px;
      resize: vertical;
      padding: 0.45rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid #d1d5db;
      font-size: 0.82rem;
      font-family: inherit;
    }
    .gate-question textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e33;
    }
    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .btn-primary {
      background: #16a34a;
      border-radius: 999px;
      color: white;
      font-size: 0.8rem;
      border: none;
      padding: 0.35rem 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      box-shadow: 0 8px 14px rgba(22, 163, 74, 0.25);
    }
    .btn-primary:hover {
      background: #15803d;
    }
    .btn-secondary {
      background: #e5e7eb;
      border-radius: 999px;
      color: #374151;
      font-size: 0.8rem;
      border: none;
      padding: 0.35rem 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .quiz-section {
      margin-top: 0.9rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
    }
    .quiz-item {
      margin-bottom: 0.6rem;
      padding: 0.45rem 0.55rem;
      border-radius: 0.7rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .quiz-item p {
      margin: 0 0 0.35rem;
      font-size: 0.82rem;
    }
    .quiz-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.25rem 0.6rem;
    }
    .quiz-options label {
      font-size: 0.8rem;
      display: flex;
      align-items: flex-start;
      gap: 0.3rem;
      cursor: pointer;
    }
    .quiz-summary {
      margin-top: 0.45rem;
      font-size: 0.8rem;
      color: #111827;
      font-weight: 500;
    }
    @media (max-width: 960px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.4);
        min-height: auto;
      }
      .main-header-top {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-content">
          <div class="sidebar-title">Simulator RME Koas</div>
          <div class="sidebar-main-title">Scaffolding & Clinical Reasoning</div>
          <div class="sidebar-subtitle">
            25 kasus sintetis (rawat jalan & rawat inap) untuk latihan penalaran klinis berbasis RME.
          </div>
        </div>
      </div>

      <div class="student-card">
        <div class="student-label">Nama mahasiswa</div>
        <input id="studentName" class="student-input" placeholder="Tulis nama Anda..." />
        <div class="student-note" id="studentGreeting">
          Progress akan tersimpan selama halaman ini terbuka.
        </div>
      </div>

      <div class="sidebar-section-title">Daftar kasus</div>
      <div class="case-list" id="caseList">
        <!-- populated via JS -->
      </div>
    </aside>

    <main class="main">
      <div class="main-header">
        <div class="main-header-top">
          <div>
            <div class="case-breadcrumb">RME edukatif • Koas</div>
            <div class="case-main-title" id="caseTitle">Pilih kasus untuk memulai</div>
            <div class="case-subtitle" id="caseSubtitle">
              Kasus akan muncul di sini.
            </div>
          </div>
          <div class="header-right">
            <div class="header-right-title">Dashboard kinerja</div>
            <div class="stat-row">
              <span class="stat-label">Mahasiswa</span>
              <span class="stat-value" id="statStudentName">-</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Progress tab</span>
              <span class="stat-value" id="statTabsProgress">0 / 0</span>
            </div>
            <div class="progress-bar">
              <div class="progress-bar-inner" id="tabsProgressBar"></div>
            </div>
            <div class="stat-row" style="margin-top:0.35rem;">
              <span class="stat-label">Skor kuis</span>
              <span class="stat-value" id="statQuizScore">-</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Profil performa</span>
              <span class="stat-value">
                <span id="statPerformanceBadge" class="badge">Belum dinilai</span>
              </span>
            </div>
            <div class="stat-row">
              <span class="stat-label">XP</span>
              <span class="stat-value" id="statXP">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Level</span>
              <span class="stat-value" id="statLevel">1</span>
            </div>
          </div>
        </div>

        <div class="tab-header-bar" id="tabHeaderBar"></div>

        <div class="content" id="contentArea">
          <div class="case-text">
            Silakan pilih salah satu kasus di sisi kiri untuk memulai simulasi. 
            Anda akan dipandu langkah demi langkah melalui tab scaffolding. 
            Setiap tab memiliki pertanyaan wajib yang perlu dijawab sebelum bisa lanjut ke tahap berikutnya.
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
        // ==== KONFIGURASI SUMBER DATA JSON (20 RAJAL + 5 RANAP) ====
    const CASE_FILES = [
      "rme_rajal_batch1.json",
      "rme_rajal_batch2.json",
      "rme_rajal_batch3.json",
      "rme_rajal_batch4.json",
      "rme_ranap_diare_21.json",
      "rme_ranap_asma_22.json",
      "rme_ranap_pielo_23.json",
      "rme_ranap_hepa_24.json",
      "rme_ranap_hipogli_25.json"
    ];

    // menampung seluruh kasus yang berhasil dimuat
    let casesData = [];

    // key untuk menyimpan progres & personalisasi di browser
    const STORAGE_KEY = "rme_koas_simulator_v1";

    // load semua file JSON dan gabungkan menjadi satu array kasus
    async function loadCasesFromFiles() {
      const allCases = [];

      for (const file of CASE_FILES) {
        try {
          const res = await fetch(file);
          if (!res.ok) {
            console.warn("Gagal memuat", file, res.status);
            continue;
          }
          const data = await res.json();
          if (Array.isArray(data)) {
            allCases.push(...data);
          } else if (data) {
            allCases.push(data);
          }
        } catch (err) {
          console.error("Error membaca", file, err);
        }
      }

      // urutkan berdasarkan case_id supaya konsisten
      allCases.sort((a, b) => (a.case_id || "").localeCompare(b.case_id || ""));
      return allCases;
    }

    // membaca progres tersimpan (jawaban + nama mahasiswa) dari localStorage
    function getSavedState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Gagal parse state tersimpan:", e);
        return null;
      }
    }

    // menyimpan progres (jawaban, skor kuis, nama) ke localStorage
    function saveState() {
      try {
        const payload = {
          answers,
          studentName: studentNameInput ? studentNameInput.value || "" : ""
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn("Gagal menyimpan state:", e);
      }
    }
function getTabs(c) {
  // 1) Jika sudah punya struktur tabs (cadangan)
  if (c.scaffolding && Array.isArray(c.scaffolding.tabs)) {
    return c.scaffolding.tabs;
  }

  // 2) Kasus rawat jalan: pakai scaffolding_steps (sudah ada)
  if (Array.isArray(c.scaffolding_steps)) {
    return c.scaffolding_steps.map((step, idx) => {
      const tabId = step.step_id || `step_${idx + 1}`;
      const prompts = Array.isArray(step.prompt_student) ? step.prompt_student : [];

      return {
        id: tabId,
        title: step.tab || `Langkah ${idx + 1}`,
        subtitle: step.stage ? `Tahap: ${step.stage}` : "",
        case_narrative: c.synopsis || c.chief_complaint || "",
        gate_questions: prompts.map((pText, qi) => ({
          id: `${tabId}_q${qi + 1}`,
          prompt: pText
        }))
      };
    });
  }

  // 3) Kasus rawat inap: scaffolding ada di dalam timeline.day_x.scaffolding
  if (c.timeline && typeof c.timeline === "object") {
    const dayEntries = Object.entries(c.timeline).sort((a, b) =>
      a[0].localeCompare(b[0])
    ); // urut: day_0, day_1, dst.

    return dayEntries.map(([dayKey, dayVal], idx) => {
      const tabId = dayKey;
      const scaffArr = Array.isArray(dayVal.scaffolding)
        ? dayVal.scaffolding
        : [];

      const gate_questions = scaffArr.map((step, i) => ({
        id: `${tabId}_${step.step_id || "s" + (i + 1)}`,
        prompt: step.prompt || step.gate || `Langkah ${i + 1}`
      }));

      return {
        id: tabId,
        title: dayVal.label || `Hari ${idx + 1}`,
        subtitle: "",
        case_narrative:
          (dayVal.clinical_data && dayVal.clinical_data.summary) ||
          c.synopsis ||
          c.chief_complaint ||
          "",
        gate_questions
      };
    });
  }

  // fallback: tidak ada scaffolding
  return [];
}

    // hitung total XP & level koas berdasarkan progres semua kasus
    // 10 XP per tab yang semua pertanyaan scaffolding-nya terisi
    // 5 XP per jawaban kuis yang benar
    function computeXPAndLevel() {
      let totalXP = 0;

      casesData.forEach(c => {
        const caseAns = answers[c.case_id] || {};
        const tabs = getTabs(c);

        // XP dari tab (scaffolding)
        tabs.forEach(tab => {
          const tabAns = caseAns[tab.id] || {};
          const gateQs = tab.gate_questions || [];
          if (
            gateQs.length &&
            gateQs.every(q => ((tabAns[q.id] || "").trim().length > 0))
          ) {
            totalXP += 10;
          }
        });

        // XP dari kuis
        const score = caseAns.quizScore;
        if (score && typeof score.correct === "number") {
          totalXP += score.correct * 5;
        }
      });

      const level = Math.floor(totalXP / 50) + 1;
      return { totalXP, level };
    }

// ==== STATE ====
    let currentCaseIndex = null;
    let currentTabIndex = 0;
    const answers = {}; // { case_id: { tabId: { questionId: text }, quiz: {questionId: idx} } }

    // ==== DOM ELEMENTS ====
    const caseListEl = document.getElementById("caseList");
    const tabHeaderBar = document.getElementById("tabHeaderBar");
    const contentArea = document.getElementById("contentArea");
    const caseTitleEl = document.getElementById("caseTitle");
    const caseSubtitleEl = document.getElementById("caseSubtitle");
    const studentNameInput = document.getElementById("studentName");
    const studentGreeting = document.getElementById("studentGreeting");
    const statStudentName = document.getElementById("statStudentName");
    const statTabsProgress = document.getElementById("statTabsProgress");
    const statQuizScore = document.getElementById("statQuizScore");
    const tabsProgressBar = document.getElementById("tabsProgressBar");
    const statPerformanceBadge = document.getElementById("statPerformanceBadge");
    const statXP = document.getElementById("statXP");
    const statLevel = document.getElementById("statLevel");

    // ==== INIT CASE LIST ====

    function renderCaseList() {
      caseListEl.innerHTML = "";
      casesData.forEach((c, idx) => {
        const item = document.createElement("div");
        item.className = "case-card";
        item.onclick = () => selectCase(idx);

        const title = document.createElement("div");
        title.className = "case-title";
        title.textContent = c.title || c.case_title || c.case_id || `Kasus ${idx + 1}`;

        const meta = document.createElement("div");
        meta.className = "case-meta";

        const pill1 = document.createElement("span");
        pill1.className = "case-meta-pill";
        pill1.textContent = c.setting || "Layanan primer";
        meta.appendChild(pill1);

        const pill2 = document.createElement("span");
        pill2.className = "case-meta-pill";
        pill2.textContent = c.department || c.unit || "Klinik umum";
        meta.appendChild(pill2);

        if (c.skdi_level) {
          const pill3 = document.createElement("span");
          pill3.className = "case-meta-pill";
          pill3.textContent = `SKDI ${c.skdi_level}`;
          meta.appendChild(pill3);
        }

        if (Array.isArray(c.tags)) {
          c.tags.slice(0, 2).forEach(t => {
            const tag = document.createElement("span");
            tag.className = "case-meta-tag";
            tag.textContent = t;
            meta.appendChild(tag);
          });
        }

        const diff = document.createElement("div");
        diff.className = "case-difficulty";
        const pill = document.createElement("span");
        pill.className = "difficulty-pill";
        const dot = document.createElement("span");
        dot.className = "difficulty-dot";
        const lab = document.createElement("span");
        lab.className = "difficulty-label";
        lab.textContent = c.difficulty_label || "sedang";
        pill.appendChild(dot);
        pill.appendChild(lab);
        diff.appendChild(pill);
        meta.appendChild(diff);

        item.appendChild(title);
        item.appendChild(meta);
        caseListEl.appendChild(item);
      });
    }

    // ==== SELECT CASE ====
    function selectCase(index) {
      currentCaseIndex = index;
      currentTabIndex = 0;

      // Mark active in sidebar
      Array.from(caseListEl.children).forEach((child, idx) => {
        child.classList.toggle("active", idx === index);
      });

      const c = casesData[index];
      caseTitleEl.textContent = c.title || c.case_title || c.case_id || `Kasus ${index + 1}`;
      caseSubtitleEl.textContent = `${c.setting || "Layanan primer"} • ${c.department || c.unit || "Unit klinis"}`;
      renderTabs();
      renderCurrentTab();
      updateDashboard();
    }

    // ==== RENDER TABS ====
    function getCompletedTabsCount(c) {
  const caseAnswers = answers[c.case_id] || {};
  const tabs = getTabs(c);
  let completed = 0;

  tabs.forEach(tab => {
    const tabAns = caseAnswers[tab.id] || {};
    const gateQs = tab.gate_questions || [];
    if (
      gateQs.length &&
      gateQs.every(q => (tabAns[q.id] || "").trim().length > 0)
    ) {
      completed++;
    }
  });

  return completed;
    }

    function renderTabs() {
      tabHeaderBar.innerHTML = "";
      if (currentCaseIndex === null) return;

      const c = casesData[currentCaseIndex];
      const tabs = getTabs(c);
      const completed = getCompletedTabsCount(c);

      tabs.forEach((tab, idx) => {
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "tab-pill";

        const enabled = idx <= completed;
        if (enabled) pill.classList.add("enabled");
        if (idx === currentTabIndex) pill.classList.add("active");

        const caseAns = answers[c.case_id] || {};
        const tabAns = caseAns[tab.id] || {};
        const gateQs = tab.gate_questions || [];
        const isCompleted = gateQs.length && gateQs.every(q => (tabAns[q.id] || "").trim().length > 0);
        if (isCompleted) pill.classList.add("completed");

        pill.onclick = () => {
          if (!enabled) {
            alert("Lengkapi tab sebelumnya terlebih dahulu.");
            return;
          }
          currentTabIndex = idx;
          renderTabs();
          renderCurrentTab();
        };

        const dot = document.createElement("span");
        dot.className = "status-dot";
        pill.appendChild(dot);

        const txt = document.createElement("span");
        txt.textContent = tab.title;
        pill.appendChild(txt);

        tabHeaderBar.appendChild(pill);
      });

      updateDashboard();
    }

    // ==== RENDER CURRENT TAB CONTENT ====
    function renderCurrentTab() {
      contentArea.innerHTML = "";
      if (currentCaseIndex === null) {
        contentArea.textContent = "Pilih kasus dari sidebar untuk mulai simulasi.";
        return;
      }

      const c = casesData[currentCaseIndex];
      const tabs = getTabs(c);
      if (!tabs.length) {
        contentArea.textContent = "Kasus ini belum memiliki tab scaffolding.";
        return;
      }
      const tab = tabs[currentTabIndex];

      const sectionTitle = document.createElement("div");
      sectionTitle.className = "section-title";
      sectionTitle.textContent = tab.title;

      const sectionSubtitle = document.createElement("div");
      sectionSubtitle.className = "section-subtitle";
      sectionSubtitle.textContent = tab.subtitle || "Baca ringkasan kasus, kemudian jawab pertanyaan di bawah.";

      const caseText = document.createElement("div");
      caseText.className = "case-text";
      caseText.textContent = tab.case_narrative || c.case_narrative || c.chief_complaint || "Ringkasan kasus akan tampil di sini.";

      contentArea.appendChild(sectionTitle);
      contentArea.appendChild(sectionSubtitle);
      contentArea.appendChild(caseText);

      // Gate questions
      if (tab.gate_questions && tab.gate_questions.length) {
        const gateWrapper = document.createElement("div");
        gateWrapper.className = "gate-questions";

        const gateTitle = document.createElement("div");
        gateTitle.className = "section-subtitle";
        gateTitle.textContent = "Pertanyaan scaffolding (wajib diisi sebelum lanjut)";
        gateWrapper.appendChild(gateTitle);

        const caseAns = (answers[c.case_id] = answers[c.case_id] || {});
        const tabAns = (caseAns[tab.id] = caseAns[tab.id] || {});

        tab.gate_questions.forEach(q => {
          const qDiv = document.createElement("div");
          qDiv.className = "gate-question";

          const label = document.createElement("label");
          label.textContent = q.prompt;

          const textarea = document.createElement("textarea");
          textarea.value = tabAns[q.id] || "";
          textarea.oninput = (e) => {
            tabAns[q.id] = e.target.value;
          };

          qDiv.appendChild(label);
          qDiv.appendChild(textarea);
          gateWrapper.appendChild(qDiv);
        });

        const btnRow = document.createElement("div");
        btnRow.className = "btn-row";

        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.className = "btn-primary";
        saveBtn.textContent = currentTabIndex === tabs.length - 1 ? "Tandai tab selesai" : "Simpan & lanjut tab berikutnya";
     saveBtn.onclick = () => {
  const allAnswered = tab.gate_questions.every(
    q => (tabAns[q.id] || "").trim().length > 0
  );
  if (!allAnswered) {
    alert("Lengkapi semua jawaban terlebih dahulu sebelum lanjut.");
    return;
  }

  // setelah jawaban terisi, hitung ulang tab yang sudah lengkap
  const completedCount = getCompletedTabsCount(c);

  // kalau masih ada tab berikutnya → maju satu tab
  if (currentTabIndex < tabs.length - 1) {
    currentTabIndex = Math.min(currentTabIndex + 1, completedCount + 1);
  } else {
    // di tab terakhir cukup beri info
    alert("Semua pertanyaan pada tab ini telah terisi.");
  }

  // SELALU render ulang tabs + konten tab saat ini
  renderTabs();
  renderCurrentTab();
  saveState();
};

        btnRow.appendChild(saveBtn);
        gateWrapper.appendChild(btnRow);
        contentArea.appendChild(gateWrapper);
      }

      // Quiz section only after last tab
      const completedCount = getCompletedTabsCount(c);
      if (completedCount === tabs.length) {
        renderQuizSection(c);
      }
    }

function renderQuizSection(c) {
  const items = getQuizItems(c);
  if (!items.length) return;

  const quizWrapper = document.createElement("div");
  quizWrapper.className = "quiz-section";

  const title = document.createElement("div");
  title.className = "section-title";
  title.textContent = "Kuis penalaran klinis";
  quizWrapper.appendChild(title);

  const subtitle = document.createElement("div");
  subtitle.className = "section-subtitle";
  subtitle.textContent = "Jawab soal berikut.";
  quizWrapper.appendChild(subtitle);

  const caseAns = (answers[c.case_id] = answers[c.case_id] || {});
  const quizAns = (caseAns.quiz = caseAns.quiz || {});

  items.forEach((q, idx) => {
    const itemDiv = document.createElement("div");
    itemDiv.className = "quiz-item";

    const p = document.createElement("p");
    const qLabel = q.type || "MCQ";
    const text = q.question || q.stem || "";
    const qId = q.quiz_id || q.id || `q${idx + 1}`;

    p.innerHTML = `<strong>Q${idx + 1} (${qLabel})</strong>: ${text}`;
    itemDiv.appendChild(p);

    const optsDiv = document.createElement("div");
    optsDiv.className = "quiz-options";

    Object.entries(q.options || {}).forEach(([key, optText]) => {
      const label = document.createElement("label");
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = qId;
      radio.value = key;
      radio.checked = quizAns[qId] === key;
      radio.onchange = () => {
        quizAns[qId] = key;
      };
      label.appendChild(radio);
      label.appendChild(document.createTextNode(`${key}. ${optText}`));
      optsDiv.appendChild(label);
    });

    itemDiv.appendChild(optsDiv);
    quizWrapper.appendChild(itemDiv);
  });

  const btnRow = document.createElement("div");
  btnRow.className = "btn-row";

  const submitQuizBtn = document.createElement("button");
  submitQuizBtn.type = "button";
  submitQuizBtn.className = "btn-primary";
  submitQuizBtn.textContent = "Hitung skor kuis";
  submitQuizBtn.onclick = () => {
    const result = computeQuizScore(c);
    const summaryEl = quizWrapper.querySelector(".quiz-summary") || document.createElement("div");
    summaryEl.className = "quiz-summary";
    const percent = result.total ? Math.round((result.correct / result.total) * 100) : 0;
    summaryEl.textContent = `Skor Anda: ${result.correct}/${result.total} (${percent}%).`;
    quizWrapper.appendChild(summaryEl);
    updateDashboard();
    saveState();
  };

  btnRow.appendChild(submitQuizBtn);
  quizWrapper.appendChild(btnRow);

  contentArea.appendChild(quizWrapper);
}

function getQuizItems(c) {
  let all = [];

  // 1. Kasus rawat jalan – quiz di level atas
  if (Array.isArray(c.quiz_items)) {
    all = all.concat(c.quiz_items);
  }

  // 2. Kasus rawat inap – quiz tersebar dalam timeline
  if (c.timeline && typeof c.timeline === "object") {
    Object.values(c.timeline).forEach(day => {

      // format 1 → day.quiz_items
      if (Array.isArray(day.quiz_items)) {
        all = all.concat(day.quiz_items);
      }

      // format 2 → day.quiz
      if (Array.isArray(day.quiz)) {
        all = all.concat(day.quiz);
      }

      // format 3 → day.final_quiz_nodes
      if (Array.isArray(day.final_quiz)) {
        all = all.concat(day.final_quiz);
      }
    });
  }

  // 3. Final quiz (kasus rawat inap)
  if (Array.isArray(c.final_quiz)) {
    all = all.concat(c.final_quiz);
  }

  return all;
}



function computeQuizScore(c) {
  const quizAns = (answers[c.case_id] || {}).quiz || {};
  let correct = 0;
  let total = 0;

  const items = getQuizItems(c);

  items.forEach((q, idx) => {
    const qId = q.quiz_id || q.id || `q${idx + 1}`;
    const keyCorrect = q.correct_option || q.correct_answer_key;
    if (!keyCorrect) return;
    total++;
    if (quizAns[qId] === keyCorrect) {
      correct++;
    }
  });

  answers[c.case_id].quizScore = { correct, total };
  return { correct, total };
}


    function updateDashboard() {
      const studentName = studentNameInput.value.trim();
      statStudentName.textContent = studentName || "-";
      if (studentName) {
        studentGreeting.textContent = `Halo, ${studentName}!`;
      } else {
        studentGreeting.textContent = "Progress akan tersimpan selama halaman ini terbuka.";
      }

      // XP & level dihitung dari semua kasus yang sudah dikerjakan
      const xpInfo = computeXPAndLevel();
      if (statXP && statLevel) {
        statXP.textContent = xpInfo.totalXP;
        statLevel.textContent = xpInfo.level;
      }

      if (currentCaseIndex === null) {
        statTabsProgress.textContent = "0 / 0";
        tabsProgressBar.style.width = "0%";
        statQuizScore.textContent = "-";
        statPerformanceBadge.textContent = "Belum dinilai";
        statPerformanceBadge.style.background = "#f9fafb";
        statPerformanceBadge.style.color = "#4b5563";
        return;
      }

const c = casesData[currentCaseIndex];
const tabs = getTabs(c);
const completed = getCompletedTabsCount(c);
statTabsProgress.textContent = `${completed} / ${tabs.length}`;
      const percent = tabs.length ? (completed / tabs.length) * 100 : 0;
      tabsProgressBar.style.width = `${percent}%`;

      const score = (answers[c.case_id] || {}).quizScore;
      if (score && score.total > 0) {
        const pct = Math.round((score.correct / score.total) * 100);
        statQuizScore.textContent = `${pct}%`;
        if (pct >= 80) {
          statPerformanceBadge.textContent = "Sangat baik";
          statPerformanceBadge.style.background = "#dcfce7";
          statPerformanceBadge.style.color = "#166534";
        } else if (pct >= 60) {
          statPerformanceBadge.textContent = "Cukup";
          statPerformanceBadge.style.background = "#fef9c3";
          statPerformanceBadge.style.color = "#854d0e";
        } else {
          statPerformanceBadge.textContent = "Perlu penguatan";
          statPerformanceBadge.style.background = "#fee2e2";
          statPerformanceBadge.style.color = "#b91c1c";
        }
      } else {
        statQuizScore.textContent = "-";
        statPerformanceBadge.textContent = "Belum dinilai";
        statPerformanceBadge.style.background = "#f9fafb";
        statPerformanceBadge.style.color = "#4b5563";
      }
    }

    // ==== EVENT: STUDENT NAME CHANGE ====
    studentNameInput.addEventListener("input", () => {
      updateDashboard();
      saveState();
    });

    // ==== INIT ====
    async function initApp() {
      // 1. muat seluruh kasus dari file JSON
      casesData = await loadCasesFromFiles();

      // 2. baca progres tersimpan (jika ada)
      const saved = getSavedState();
      if (saved && saved.answers) {
        Object.assign(answers, saved.answers);
      }
      if (saved && saved.studentName) {
        studentNameInput.value = saved.studentName;
      }

      // 3. render UI awal
      renderCaseList();
      updateDashboard();
    }

    initApp();
  </script>
</body>
</html>
